name: Claude Auto Implement (Scheduled)

on:
  schedule:
    # 5æ™‚é–“ã”ã¨: UTC 0, 5, 10, 15, 20æ™‚
    - cron: '0 0,5,10,15,20 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

concurrency:
  group: auto-implement
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_issues: ${{ steps.set-matrix.outputs.has_issues }}
    steps:
      - name: Get auto-implement issues
        id: set-matrix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # auto-implementãƒ©ãƒ™ãƒ«ä»˜ãã§ã€implementingãƒ©ãƒ™ãƒ«ãªã—ã®issueã‚’å–å¾—
          issues=$(gh issue list \
            --repo ${{ github.repository }} \
            --label "auto-implement" \
            --state open \
            --json number,title,labels \
            --limit 10)

          # implementingãƒ©ãƒ™ãƒ«ä»˜ãã‚’é™¤å¤–
          filtered=$(echo "$issues" | jq '[.[] | select(.labels | map(.name) | contains(["implementing"]) | not)]')

          # æœ€å¤§2ä»¶ã«åˆ¶é™
          limited=$(echo "$filtered" | jq '.[0:2]')

          # ä»¶æ•°ãƒã‚§ãƒƒã‚¯
          count=$(echo "$limited" | jq 'length')

          if [ "$count" -eq 0 ]; then
            echo "No issues to implement"
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "matrix={\"issue\":[]}" >> $GITHUB_OUTPUT
          else
            echo "Found $count issue(s) to implement"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            # matrixå½¢å¼ã«å¤‰æ›
            matrix=$(echo "$limited" | jq -c '{issue: .}')
            echo "matrix=$matrix" >> $GITHUB_OUTPUT
          fi

  implement:
    needs: prepare
    if: needs.prepare.outputs.has_issues == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 1 # rate limitå¯¾ç­–ã§é †æ¬¡å®Ÿè¡Œ
      fail-fast: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add implementing label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --add-label "implementing"

      - name: Fetch issue details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issueæœ¬æ–‡ã‚’å–å¾—
          gh issue view ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --json title,body \
            --jq '.title' > issue-title.txt

          gh issue view ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --json body \
            --jq '.body' > issue-body.md

          echo "Issue #${{ matrix.issue.number }}: $(cat issue-title.txt)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## ã‚¿ã‚¹ã‚¯
            Issue #${{ matrix.issue.number }} ã®å†…å®¹ã«åŸºã¥ã„ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ## å®Ÿè¡Œæ‰‹é †
            1. issue-title.txt ã¨ issue-body.md ã‚’èª­ã‚“ã§å†…å®¹ã‚’æŠŠæ¡
            2. CLAUDE.md ã‚’èª­ã‚“ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æŠŠæ¡
            3. docs/TEMPLATE.md ã‚’èª­ã‚“ã§è¨˜äº‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æŠŠæ¡
            4. å¿…è¦ãªå¤‰æ›´ã‚’å®Ÿè£…
            5. npm run lint ã§textlintã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèª
            6. å¤‰æ›´å†…å®¹ã‚µãƒãƒªãƒ¼ã‚’ /tmp/change-summary.txt ã«å‡ºåŠ›

            ## é‡è¦
            - CLAUDE.md ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã†
            - ãƒ•ã‚¡ã‚¤ãƒ«åã¯æ—¥æœ¬èª
            - Mermaidå›³ã‚’ç©æ¥µçš„ã«æ´»ç”¨
            - å°å…¥å•é¡Œã‹ã‚‰å§‹ã‚ã‚‹æ§‹æˆã‚’å®ˆã‚‹
            - issue-body.md, issue-title.txt ã¯å‚ç…§ã®ã¿ï¼ˆã‚³ãƒŸãƒƒãƒˆã«å«ã‚ãªã„ï¼‰

      - name: Clean up temporary files
        run: |
          rm -f issue-title.txt issue-body.md

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
          branch_name="auto/implement-issue-${{ matrix.issue.number }}"
          git checkout -b "$branch_name"

          # ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "feat: $(cat /tmp/change-summary.txt 2>/dev/null || echo '${{ matrix.issue.title }}')" \
            -m "" \
            -m "Closes #${{ matrix.issue.number }}" \
            -m "" \
            -m "Co-Authored-By: Claude <noreply@anthropic.com>"

          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "$branch_name"

          # PRæœ¬æ–‡ä½œæˆ
          issue_number="${{ matrix.issue.number }}"
          {
            echo "## Summary"
            echo ""
            echo "Issue #${issue_number} ã®è‡ªå‹•å®Ÿè£…ã§ã™ã€‚"
            echo ""
            echo "## Changes"
            echo ""
            if [ -f /tmp/change-summary.txt ]; then
              cat /tmp/change-summary.txt
            else
              echo "Claude Codeã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…"
            fi
            echo ""
            echo "## Test Plan"
            echo ""
            echo "- [ ] textlintã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨"
            echo "- [ ] è¨˜äº‹ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ã„ã“ã¨"
            echo "- [ ] Mermaidå›³ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨"
            echo ""
            echo "---"
            echo "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"
          } > /tmp/pr-body.md

          # PRä½œæˆ
          gh pr create \
            --title "feat: ${{ matrix.issue.title }} (closes #${{ matrix.issue.number }})" \
            --body-file /tmp/pr-body.md \
            --label "auto-implement" \
            --label "documentation"

      - name: Remove implementing label
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --remove-label "implementing" || true

      - name: Update labels on success
        if: success() && steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --add-label "implemented"

          gh issue comment ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --body "âœ… è‡ªå‹•å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚PRã‚’ã”ç¢ºèªãã ã•ã„ã€‚"

      - name: Update labels on failure
        if: failure() || (success() && steps.changes.outputs.has_changes == 'false')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --add-label "auto-implement-failed"

          if [ "${{ steps.changes.outputs.has_changes }}" == "false" ]; then
            message="âš ï¸ è‡ªå‹•å®Ÿè£…ã‚’è©¦ã¿ã¾ã—ãŸãŒã€å¤‰æ›´ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚Issueã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          else
            message="âŒ è‡ªå‹•å®Ÿè£…ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi

          gh issue comment ${{ matrix.issue.number }} \
            --repo ${{ github.repository }} \
            --body "$message"
